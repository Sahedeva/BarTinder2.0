		<% include ./partials/header %>

			<!-- Possible modal for the bar information -->

			<h2 class="venue_name" id="venue_info"></h2>
				<!-- name will be appended by ajax call -->
			<div class="view_counter fill container-fluid">
				<!-- Had to put these styles inline because the url squid tag would not pull in through the css -->
				<!-- The styles will be appended by ajax call -->
				<div class='patron_number'>
					<!-- This div is for the disco ball gif -->
				</div>
			</div>

			<div class="comment_box container-fluid">
				<!-- comments will be appended by ajax call -->
			</div>

			<div id="pat_num" >
				<!-- patron number / capacity will be appended by ajax call -->
			</div>

			<nav class="navbar navbar-default navbar-fixed-bottom">
        <div class="footbox">
	    		<button type="button" name="arrow" id="backward_button" class="arrow_btn btn btn-default btn-lg">
						<span class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span> Back</button>
	    		<button type="button" id="forward_button" class="arrow_btn btn btn-default btn-lg" name="arrow">
						Next <span class="glyphicon glyphicon-arrow-right" aria-hidden="true"></span></button>
      	</div>
	   	</nav>
	
		<% include ./partials/footer %>

		<script>
			//Need to get data for venue prior to page load
			var disco;

			ajax_page_load();

			$('#forward_button').on('click', function(){
							advance(<%= venues_length %>);
			});

			$('#backward_button').on('click', function(){
							backward();
						});

			// if (localStorage.getItem("current_venue") === null) {
			// 		var current_venue = 0;
			// 		var venue_id = "562556ce659ab632c6eccdb8";
			// 		setInterval('venueUpdate()', 1000);
			// 	} else {
			// 		current_venue = localStorage.getItem("current_venue");
			// 		venue_id = localStorage.getItem("venue_id");
			// 		setInterval('venueUpdate()', 1000);
			// 	};
			
			//render of page with ajax not page refresh - need to get data
			//if session is new will intitialize variables and set current venue to zero
			//ajax function to load in variables for fields and append to dom
			function ajax_page_load() {
				var venue = {
										    "_id": "562556ce659ab632c6eccdb8",
										    "name": "The Ginger Man",
										    "location": "301 Lavaca St, Austin TX 78701",
										    "hours": "Monday through Thursday 2PM - 2AM, Friday through Sunday 1PM - 2AM",
										    "logo_url": "http://i.imgur.com/aiJjkYf.jpg",
										    "website_url": "http://thegingerman.com/austin/",
										    "capacity": "250",
										    "patron_number": 150,
										    "comment": "Free date with Mike Dang - PackMaster",
										    "recent_modified": false,
										}
				if (localStorage.getItem("current_venue")) {
					current_venue = localStorage.getItem("current_venue");
					// venue_id = localStorage.getItem("venue_id");
					position = localStorage.getItem("position");
					rand_num = localStorage.getItem("rand_num");
					rand_array = JSON.parse(localStorage["rand_array"]);
					// rand_array = localStorage.getItem("rand_array");
					count = localStorage.getItem("count");
					current_venue_array = JSON.parse(localStorage["current_venue_array"]);
					current_venue_array = localStorage.getItem("current_venue_array");
					// console.log("venue array after parse from local storage: "+ current_venue_array);
					// var position = 0;
					// var rand_array = [0];
					// var rand_num = 0;
					// var count = 0;
					// var current_venue_array = [0];
					// var current_venue = 0;
					// var venue_id = "562556ce659ab632c6eccdb8";
					// localStorage.setItem("current_venue", current_venue);
					// localStorage.setItem("position", position);
					// localStorage.setItem("rand_num", rand_num);
					// localStorage["rand_array"] = JSON.stringify(rand_array);
					// localStorage.setItem("count", count);
					// localStorage["current_venue_array"] = JSON.stringify(current_venue_array);
					// console.log("Current venue else before home render call: "+current_venue);
					home_render(current_venue);
				} else {
					//initializing variables if nothing in local storage
					var position = 0;
					var rand_array = [0];
					var rand_num = 0;
					var count = 0;
					var current_venue_array = [0];
					var current_venue = 0;
					// var venue_id = "562556ce659ab632c6eccdb8";
					localStorage.setItem("current_venue", current_venue);
					// localStorage.setItem("venue_id", venue_id);
					localStorage.setItem("position", position);
					localStorage.setItem("rand_num", rand_num);
					// localStorage.setItem("rand_array", rand_array);
					localStorage["rand_array"] = JSON.stringify(rand_array);
					localStorage.setItem("count", count);
					localStorage["current_venue_array"] = JSON.stringify(current_venue_array);
					// localStorage.setItem("current_venue_array", current_venue_array);
					console.log("Current venue else before home render call: "+current_venue);
					home_render(current_venue);
				}
			};
			//Ajax call to home render
			var ven_up
			function home_render(current_venue){
				if (ven_up){
				clearInterval(ven_up);
				}
				var clicks = 0;
				console.log("Current venue of home render call: "+current_venue);
				$.ajax({
					url: '/home_render',
          dataType: "json",
          method: "POST",
          data: {
            current_venue: current_venue
            },
          success: function(data, textStatus, jqXHR){
          	console.log(data);
            current_venue=data['current_venue'];
            venue=data['venue'];
            venues_length=data['venues_length'];
            venue_name = venue['name'];
            venue_logo = venue.logo_url;
            venue_id = venue['_id'];
            ven_up = setInterval('venueUpdate(venue_id)', 2000);
            venue_comment = venue.comment;
            patron_number = venue.patron_number;
            capacity = venue.capacity;
            comment_html = "<p>"+venue_comment+"</p>";
            url_css = "url("+venue_logo+")";
            number_html = patron_number+"<span style=''> / </span>"+capacity
            $('#venue_info').html(venue_name);
            bar_info(venue, clicks);
            $('.fill').css({
    										'overflow': 'hidden',
    										'background-size': '100%',
    										'background-position': 'center',
    										'background-image': url_css,
    										'opacity': '0.7'
            					});
            $('.comment_box').html(comment_html);
            $('#pat_num').html(number_html);
            // number changing color logic
            clearInterval(disco);
						var count_fraction = parseFloat(patron_number)/capacity;
						console.log(count_fraction);
						if (count_fraction <= 0.30){
							console.log("<30% Blue");			
							$('#pat_num').css('color', '#00FFFF');
							$('.patron_number').html("");
							clearInterval(disco);
						} 
						else if (count_fraction <= 0.60){
							console.log("<60% Yellow");				
							$('#pat_num').css('color', '#FFFF00');
							$('.patron_number').html("");
							clearInterval(disco);
						}
						else if (count_fraction <= 0.90){
							console.log("<90% Red");			
							$('#pat_num').css('color', '#FF0040');
							$('.patron_number').html("");
							clearInterval(disco);
						}
						else {
							console.log(">90% disco");
							$('#pat_num').css('color', 'white');
							// class name of disco div is animated bounceInLeft ///
							disco = setInterval('disco_ball_gif()', 3000 );
							// function disco_ball_gif(){
							// 	$('.patron_number').html('<iframe  class="animated bounceInLeft" id="disco" src="//giphy.com/embed/jRx59nrqDtXHy" leftframeBorder="0" class="giphy-embed" allowFullScreen></iframe><p><a href="http://giphy.com/gifs/party-ball-lights-jRx59nrqDtXHy"></a></p>')
							// }
						}
						//dom is properly set up with variables and color changes	
					}
				});
			};

			//disco ball gif function
			function disco_ball_gif(){
								$('.patron_number').html('<iframe  class="animated bounceInLeft" id="disco" src="//giphy.com/embed/jRx59nrqDtXHy" leftframeBorder="0" class="giphy-embed" allowFullScreen></iframe><p><a href="http://giphy.com/gifs/party-ball-lights-jRx59nrqDtXHy"></a></p>')
			};

			// bar info drops down when clicking bar name
			function bar_info(venue, clicks){
			
				$('#venue_info').on('click', function() {
	  			clicks++
	  			if (clicks % 2 == 1) {
	  				// location = venue['location'];
	  				// website_url = venue['website_url'];
	  				hours = venue['hours'];
	  				name = venue['name'];
	  				console.log('odd click');
	  				$('#venue_info').html(name + '</br><ul><li><span class="info">LOCATION:</span>'+ venue['location'] +'</li><li><span class="info">HOURS:</span>   <'+hours+'</li><li><a href="'+venue['website_url']+'" target="_blank">'+venue['website_url']+'</li></ul>');
			 			
	     	// odd clicks
	  			} else {
	  				name = venue['name'];
	  				console.log('even click');
			 			$('#venue_info').html(name);
	     	// even clicks
	  			}
				});
			};

			//logic for forward and back buttons - ajax calls
			var storage_object = {};
			function advance(venues_length) {
				storage_getter();
				console.log(storage_object);
				var position = storage_object['position'];
				var rand_array = storage_object['rand_array'];
				var rand_num = storage_object['rand_num'];
				var count = storage_object['count'];
				var current_venue_array = storage_object['current_venue_array'];
				var current_venue = storage_object['current_venue'];
				// var venue_id = storage_object['venue_id'];
				position++
				console.log("Forward button clicked");
	      	if (position < current_venue_array.length) {
	      		console.log("position after forward first if: "+position);
	      		console.log("venue length after forward first if: "+current_venue_array.length);
	      		console.log("current_venue_array after forward first if type of: " + typeof current_venue_array+" : "+current_venue_array);
	        	current_venue = current_venue_array[position] ;
	        	console.log("current venue after forward first if: "+current_venue);
	        	console.log("current_venue_array after forward first if: "+current_venue_array);
						storage_setter(current_venue,position,rand_num,rand_array,count,current_venue_array);
						home_render(current_venue);
	      	}
	      	else {
		      	var repeat= true;

		      	while (repeat)
		      	{
		        rand_num = Math.floor(Math.random()*venues_length); 

		        for(var i=0; i<=count; i++)
		        {
		          if (rand_array[i] == rand_num)
		          {
		            repeat=true;
		            break;
		          }
		          else 
		            repeat=false;
		        }

		        if(repeat)
		          continue;
		      	}

		      	rand_array[count]=rand_num;
		      	count++;

		      	if (rand_array.length == venues_length){
		        	rand_array = [];
		        	count=0;
		      	}

		      	console.log(rand_array);
		      	current_venue = rand_num;
		      	current_venue_array.push(current_venue);
		      	console.log("Venue array after 'push': " + current_venue_array);
							if (position > 4) {
						  	position = 4;
						  	current_venue_array.shift();
							}
						console.log("current venue after randomizer: "+current_venue);
						storage_setter(current_venue,position,rand_num,rand_array,count,current_venue_array);
						home_render(current_venue);
					}
					
			};

			function backward() {
				console.log("Back button clicked");
				storage_getter();
				var position = storage_object['position'];
				var rand_array = storage_object['rand_array'];
				var rand_num = storage_object['rand_num'];
				var count = storage_object['count'];
				var current_venue_array = storage_object['current_venue_array'];
				var current_venue = storage_object['current_venue'];
				// var venue_id = storage_object['venue_id'];
				position--
  			if (position < 0){
    			position = 0;
    			return;
  			}
  			current_venue = current_venue_array[position];
  			console.log("current venue after backward: "+current_venue);
  			console.log("Venue array after backward: " + current_venue_array);
  			storage_setter(current_venue,position,rand_num,rand_array,count,current_venue_array);
  			home_render(current_venue);
			};

			function storage_setter(current_venue,position,rand_num,rand_array,count,current_venue_array){
				localStorage.setItem("current_venue", current_venue);
				localStorage.setItem("venue_id", venue_id);
				localStorage.setItem("position", position);
				localStorage.setItem("rand_num", rand_num);
				localStorage["rand_array"] = JSON.stringify(rand_array);
				// localStorage.setItem("rand_array", rand_array);
				localStorage.setItem("count", count);
				localStorage["current_venue_array"] = JSON.stringify(current_venue_array);
				// localStorage.setItem("current_venue_array", current_venue_array);
			};

			function storage_getter(){
				current_venue = localStorage.getItem("current_venue");
				// venue_id = localStorage.getItem("venue_id");
				position = localStorage.getItem("position");
				rand_num = localStorage.getItem("rand_num");
				// rand_array = localStorage.getItem("rand_array");
				// console.log("Rand array in storage getter - non parsed: "+ array_rand);
				rand_array = JSON.parse(localStorage["rand_array"]);
				// rand_array = localStorage.getItem("rand_array");
				count = localStorage.getItem("count");
				current_venue_array = JSON.parse(localStorage["current_venue_array"]);
				// current_venue_array = localStorage.getItem("current_venue_array");
				storage_object = {
					"current_venue": current_venue,
					"position": position,
					"rand_num": rand_num,
					"rand_array": rand_array,
					"count": count,
					"current_venue_array": current_venue_array
				}
				return storage_object;
			};
			
			function venueUpdate(venue_id) {
				
				$.ajax({
            url: '/wasVenueUpdated',
            dataType: "json",
            method: "POST",
            data: {
              venue_id: venue_id,
              },
            success: function(data, textStatus, jqXHR){
              recent_modified = data['recent_modified'];
              if (recent_modified) {
              	$.ajax({
              		url: '/home_refreshed',
            			dataType: "json",
            			method: "POST",
            			data: {
              			venue_id: venue_id
              		},
            			success: function(data, textStatus, jqXHR){
            				current_venue = localStorage.getItem("current_venue");
            				// current_venue = data['current_venue'];
            				// localStorage.setItem("current_venue", current_venue);
            				home_render(current_venue);
            				console.log("Ajax call to home refresh: if recent modifed is false you shouldnt see this");
            				console.log("recent_modified: " + recent_modified);
            				
            				console.log("page should have updated");
              		},
              		error: function(XMLHttpRequest, textStatus, errorThrown){
            			}

              		});
            		}
            	},
            	error: function(XMLHttpRequest, textStatus, errorThrown){
            	}
         		});
				};

		</script>



